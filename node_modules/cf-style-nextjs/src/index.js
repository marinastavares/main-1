import React from 'react';
import {
  createRenderer,
  StyleProvider as StyleProviderComponent
} from 'cf-style-provider';
import { renderToSheetList } from 'fela-dom'; // eslint-disable-line behance/no-deprecated
import PropTypes from 'prop-types';

const felaRenderer = createRenderer();

const getInitialProps = callback => nextObj => {
  const page = nextObj.renderPage();
  const cfFelaSheetList = renderToSheetList(felaRenderer);
  felaRenderer.clear();
  const userProps = callback ? callback(nextObj) : {};
  return {
    ...page,
    ...userProps,
    cfFelaSheetList
  };
};

const getStyles = props =>
  props.cfFelaSheetList.map(({ type, media, css }) => (
    <style
      dangerouslySetInnerHTML={{ __html: css }}
      data-fela-type={type}
      key={`${type}-${media}`}
      media={media}
    />
  ));

const StyleProvider = ({ children }) => (
  <StyleProviderComponent renderer={felaRenderer}>
    {children}
  </StyleProviderComponent>
);

StyleProvider.propTypes = {
  children: PropTypes.node
};

export { StyleProvider, getInitialProps, getStyles };
