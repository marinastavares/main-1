import { objectReduce, clusterCache, RULE_TYPE, KEYFRAME_TYPE, FONT_TYPE, STATIC_TYPE } from 'fela-utils';

import createStyleTagMarkup from './createStyleTagMarkup';
import getRehydrationIndex from './getRehydrationIndex';

var sheetMap = {
  fontFaces: FONT_TYPE,
  statics: STATIC_TYPE,
  keyframes: KEYFRAME_TYPE,
  rules: RULE_TYPE
};

export default function renderToMarkup(renderer) {
  var cacheCluster = clusterCache(renderer.cache, renderer.mediaQueryOrder);

  var rehydrationIndex = getRehydrationIndex(renderer);

  var basicMarkup = objectReduce(sheetMap, function (markup, type, key) {
    if (cacheCluster[key].length > 0) {
      markup += createStyleTagMarkup(cacheCluster[key], type, '', rehydrationIndex);
    }

    return markup;
  }, '');

  return objectReduce(cacheCluster.mediaRules, function (markup, css, media) {
    if (css.length > 0) {
      markup += createStyleTagMarkup(css, RULE_TYPE, media, rehydrationIndex);
    }

    return markup;
  }, basicMarkup);
}